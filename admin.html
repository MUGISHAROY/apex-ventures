<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Admin | Master Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        :root { 
            --gold: #FFD700; --bg: #050505; --surface: #121212; --border: #333; --text: #e0e0e0; 
            --font-head: 'Outfit', sans-serif; --font-body: 'Plus Jakarta Sans', sans-serif;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; font-family: var(--font-body); overflow:hidden; }
        
        /* AUTH & SIDEBAR styles remain similar */
        #authBox { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; justify-content: center; align-items: center; }
        .login-card { background: var(--surface); padding: 50px; border: 1px solid var(--gold); border-radius: 16px; text-align: center; width: 100%; max-width: 400px;}
        
        .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 8px; transition: width 0.3s ease; }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .label, .sidebar.collapsed .brand span { display: none; }
        
        .brand { font-family: var(--font-head); font-weight: 900; font-size: 1.2rem; color: #fff; margin-bottom: 30px; }
        .brand span { color: var(--gold); }
        .nav-item { padding: 14px 16px; cursor: pointer; border-radius: 10px; color: #888; font-weight: 600; display: flex; gap: 12px; align-items: center; }
        .nav-item:hover, .nav-item.active { background: var(--gold); color: #000; }

        .content { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        .card { background: var(--surface); border: 1px solid var(--border); padding: 30px; border-radius: 16px; margin-bottom: 20px; }
        
        input, select { padding: 14px; background: #080808; border: 1px solid var(--border); color: #fff; width: 100%; margin-bottom: 12px; border-radius: 10px; outline:none; }
        input:focus { border-color: var(--gold); }
        .btn { width: 100%; padding: 14px; background: var(--gold); border: none; font-weight: 800; cursor: pointer; color: #000; border-radius: 10px; margin-top: 10px; }
        
        /* NEW STYLES FOR BADGES & ORDERS */
        .checkbox-group { display: flex; gap: 20px; margin-bottom: 15px; }
        .checkbox-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; color: #ccc; font-size: 0.9rem; }
        .checkbox-group input { width: auto; margin: 0; }
        
        .order-actions button { padding: 5px 10px; font-size: 0.7rem; margin-left: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-ship { background: #3498db; color: white; }
        .btn-done { background: #2ecc71; color: white; }
        .btn-del { background: #e74c3c; color: white; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .st-pending { background: rgba(255, 165, 0, 0.2); color: orange; }
        .st-shipped { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .st-delivered { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }

        #previewImg { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; display: none; margin-bottom: 10px; border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <div id="authBox">
        <div class="login-card">
            <h2>SYSTEM LOCKED</h2>
            <input type="password" id="pass" placeholder="Enter Access Key">
            <button class="btn" onclick="login()">UNLOCK</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand">APEX <span>VENTURES</span> <button onclick="document.getElementById('sidebar').classList.toggle('collapsed')" style="background:none; border:none; color:#666; cursor:pointer;">‚ò∞</button></div>
        <div class="nav-item active" onclick="nav('orders', this)"><span>üöÄ</span> <span class="label">ORDERS</span></div>
        <div class="nav-item" onclick="nav('inventory', this)"><span>üì¶</span> <span class="label">ADD STOCK</span></div>
        <div class="nav-item" onclick="nav('categories', this)"><span>üìÇ</span> <span class="label">FOLDERS</span></div>
    </div>

    <main class="content">
        <div id="orders" class="section active">
            <h2>Active Order Tracking</h2>
            <div id="orderList" class="card"><div style="text-align:center; padding:20px;">Loading...</div></div>
        </div>

        <div id="inventory" class="section">
            <h2>Add Premium Stock</h2>
            <div class="card">
                <h3>Product Details</h3>
                <input id="pName" placeholder="Product Name (e.g. iPhone 14 Pro)">
                
                <div style="display:flex; gap:10px;">
                    <select id="pCat" onchange="loadSubOptions()"><option>Loading...</option></select>
                    <select id="pSubCat"><option value="">Sub Folder</option></select>
                </div>

                <div style="display:flex; gap:10px;">
                    <input id="pPrice" type="number" placeholder="Price (UGX)">
                    <input id="pStock" type="number" placeholder="Qty In Stock (e.g. 5)">
                </div>

                <div class="checkbox-group">
                    <label><input type="checkbox" id="pVerified" checked> ‚úÖ Verified Authentic</label>
                    <label><input type="checkbox" id="pPremium"> ‚≠ê Premium Offer</label>
                </div>
                
                <h3 style="margin-top:10px; font-size:0.9rem; color:#888;">Product Image</h3>
                <input type="file" id="pImgFile" accept="image/*" onchange="previewFile()">
                <img id="previewImg" src="" alt="Preview">

                <button class="btn" onclick="addProd()">PUBLISH TO MARKET</button>
            </div>
        </div>

        <div id="categories" class="section">
            <h2>Folder Manager</h2>
            <div class="card">
                <input id="newCatName" placeholder="New Main Folder Name">
                <button class="btn" onclick="addCategory()">CREATE FOLDER</button>
                <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <select id="targetCat"></select>
                    <input id="newSubName" placeholder="New Sub-Folder Name" style="margin-top:10px;">
                    <button class="btn" onclick="addSubCategory()" style="background:#fff; color:#000;">ADD SUB-FOLDER</button>
                </div>
            </div>
            <div id="catList" class="card"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA0PaOJo_SZ7VsSu8qhJL_MAGCj_KwWtTI", projectId: "apex-ventures-340ac", appId: "1:668172357038:web:a58bb2af59d3857fd84c3f" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allCategories = [];

        window.login = () => { if(document.getElementById('pass').value==="roy256") { document.getElementById('authBox').style.display='none'; initListeners(); } else { alert("Access Denied"); } }
        window.nav = (id, el) => { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); }
        window.previewFile = () => { const f=document.getElementById('pImgFile').files[0]; const r=new FileReader(); r.onload=()=> {document.getElementById('previewImg').src=r.result; document.getElementById('previewImg').style.display='block';}; if(f) r.readAsDataURL(f); }

        function initListeners() {
            // ORDERS (With Status Management)
            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), snap => {
                const list = document.getElementById('orderList');
                list.innerHTML = snap.empty ? '<div style="text-align:center; padding:20px;">No active orders.</div>' : '';
                snap.forEach(d => {
                    const o = d.data();
                    const statusClass = o.status === 'Delivered' ? 'st-delivered' : (o.status === 'Shipped' ? 'st-shipped' : 'st-pending');
                    const statusText = o.status || 'Pending';
                    
                    list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #333; align-items:center;">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem; color:white;">${o.total}</div>
                            <div style="color:var(--gold); font-size:0.9rem;">${o.items ? o.items.length : 1} Items ‚Ä¢ ${new Date(o.date).toLocaleTimeString()}</div>
                            <div style="margin-top:5px;"><span class="status-badge ${statusClass}">${statusText}</span></div>
                        </div>
                        <div class="order-actions">
                            <button class="btn-ship" onclick="setStatus('${d.id}', 'Shipped')">SHIP</button>
                            <button class="btn-done" onclick="setStatus('${d.id}', 'Delivered')">DONE</button>
                            <button class="btn-del" onclick="delOrder('${d.id}')">‚úï</button>
                        </div>
                    </div>`;
                });
            });

            // CATEGORIES
            onSnapshot(query(collection(db, "categories"), orderBy("name")), snap => {
                const list = document.getElementById('catList'); const sel1 = document.getElementById('pCat'); const sel2 = document.getElementById('targetCat');
                list.innerHTML = ''; sel1.innerHTML = '<option value="" disabled selected>Select Main...</option>'; sel2.innerHTML = '<option value="" disabled selected>Select Main...</option>';
                allCategories = [];
                snap.forEach(d => {
                    const c = d.data(); c.id = d.id; allCategories.push(c);
                    list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;"><span>${c.name} <small style="color:#666;">(${c.subs ? c.subs.length : 0})</small></span> <button onclick="delCategory('${d.id}')" style="color:red; background:none; border:none; cursor:pointer;">DEL</button></div>`;
                    let opt = `<option value="${c.val}">${c.name}</option>`; sel1.innerHTML += opt;
                    let opt2 = `<option value="${d.id}">${c.name}</option>`; sel2.innerHTML += opt2;
                });
            });
        }

        window.loadSubOptions = () => {
            const val = document.getElementById('pCat').value; const sub = document.getElementById('pSubCat'); sub.innerHTML = '<option value="">Sub Folder</option>';
            const cat = allCategories.find(c => c.val === val);
            if(cat && cat.subs) cat.subs.forEach(s => sub.innerHTML += `<option value="${s}">${s}</option>`);
        }

        window.addProd = async () => {
            const btn = document.querySelector('#inventory .btn');
            btn.innerText = "UPLOADING...";
            const imgFile = document.getElementById('pImgFile').files[0];
            
            const saveToDb = async (url) => {
                await addDoc(collection(db, "inventory"), {
                    name: document.getElementById('pName').value,
                    cat: document.getElementById('pCat').value,
                    subcat: document.getElementById('pSubCat').value,
                    price: document.getElementById('pPrice').value,
                    stock: parseInt(document.getElementById('pStock').value) || 1, // New Stock Field
                    verified: document.getElementById('pVerified').checked, // New Badge
                    premium: document.getElementById('pPremium').checked,   // New Badge
                    img: url,
                    date: new Date().toISOString()
                });
                alert("Published!"); btn.innerText = "PUBLISH TO MARKET";
                document.getElementById('pName').value = '';
            };

            if(imgFile) {
                const r = new FileReader(); r.onload = (e) => saveToDb(e.target.result); r.readAsDataURL(imgFile);
            } else { saveToDb('https://via.placeholder.com/300'); }
        }

        window.setStatus = async (id, status) => { await updateDoc(doc(db, "orders", id), { status: status }); }
        window.delOrder = async (id) => { if(confirm("Delete Order?")) await deleteDoc(doc(db, "orders", id)); }
        window.addCategory = async () => { await addDoc(collection(db, "categories"), { name: document.getElementById('newCatName').value, val: document.getElementById('newCatName').value.toLowerCase().replace(/ /g,'_'), subs: [] }); }
        window.addSubCategory = async () => { await updateDoc(doc(db, "categories", document.getElementById('targetCat').value), { subs: arrayUnion(document.getElementById('newSubName').value) }); }
        window.delCategory = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "categories", id)); }
    </script>
</body>
</html>